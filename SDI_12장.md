
## 요구사항
- 1:1 채팅, 1:N 채팅 모두 지원
- 웹, 모다일 둘다 지원
- DAU (Daily Active User) 5천만명
- 1:N 채팅의 경우 100명 제한
- 메시지는 텍스트만 가능하고 10만자 이하만 허용
- 메시지는 영원히 보관
- 사용자의 접속상태 표시
- 하나의 계정으로 여러 단말에 동시 접속 가능

## 기본 동작방식
1. 고객이 서비스에 가입
2. 모든 사용자를 검색할수 있다.
3. 특정 사용자를 골라서 1:1 채팅이 가능하다.
4. 다수의 사용자(최대 100명)를 골라서 1:N 채팅이 가능하다.

## 1:1 채팅이 일어나는 과정
1. 모든 고객은 자신의 메시지함을 가지고 있다.
2. 자신의 메시지함은 mongoDB상에 컬랙션으로 존재하고 항상 디스크에 동기화된다. (지속적으로 샤드가 추가되는 구조)
3. 메시지함에 메시지가 생성되는 즉시 자신의 메시지큐에 메시지가 발행된다.
4. MSG TAG에 의해 특정 컨슈머로 메시지가 Async로 전달된다.
5. 상대방이 로그인했을경우 웹소켓이 접속되고 해당 웹소켓에 대응되는 컨슈머가 메시지를 지속적으로 Push 한다.
6. 고객 ID 기준으로 현재 활성화된 단말기를 Pub/Sub으로 등록하고 등록된 단말기 모두에게 브로드케스팅한다.

## 1:N 채팅이 일어나는 과정
1. 누군가 채팅방을 생성하고 ChannelId가 발행된다.
2. 이때 구성원 모두에게 별도의 웹소켓이 접속되고 ChannelId에 대응하는 구성원 리스트가 생성된다. (Redis List 자료구조)
3. 구성원 모두가 메시지를 생성할수 있고 메시지가 생성되면 개인별 메시지큐로 메시지가 발생된다.
4. 컨슈머는 메시지가 전달되면 1:1 채팅인지 1:N 채팅인지 분기하여 웹소켓으로 메시지를 Push 한다.
6. 고객 ID 기준으로 현재 활성화된 단말기를 Pub/Sub으로 등록하고 등록된 단말기 모두에게 브로드케스팅한다.

## 기타
- 웹소켓은 [고객ID + 단말기ID] 헝태로 접속되므로 한명의 사용자가 다수의 단말기로 메시지를 받을수 있다.
- 고객ID 기준으로 하나의 웹소켓이라도 접속되도 있다면 고객이 접속한 것으로 가정한다.
- 웹소켓은 비교적 쉽게 접속이 끊어질 수 있으므로 Push할 데이터는 항상 메시지큐에 보관해야 한다.
- 고객의 어떤 단말기라도 메시지를 받으면 메시지를 받은것으로 mongoDB에 마킹한다.
- 고객의 단말기 화면을 Refrash하면 지금까지 받은 처리가 된 메시지가 노출되고 웹소켓이 다시 연결된다. 
 


